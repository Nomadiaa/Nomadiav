{% extends "base.twig" %}

{% block title %}{{ destination.titre }} - {{ destination.pays }}{% endblock %}

{% block style %}
  <link rel="stylesheet" href="/assets/css/destinations.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
{% endblock %}

{% block main %}

{# ‚úÖ Corrige le chemin de l'image principale #}
{% set mainImagePath = destination.imagePrincipale starts with '/uploads/' ? destination.imagePrincipale : '/uploads/' ~ destination.imagePrincipale %}

<div class="banner">
  <img src="{{ mainImagePath }}" alt="Image de {{ destination.titre }}">
  <div class="banner-overlay">
    <div class="banner-content">
      <h1 class="destination-title">{{ destination.titre }}</h1>
      <p class="destination-country">{{ destination.pays }}</p>

      <!-- ‚úÖ Boutons d‚Äôaction -->
      <div style="display: flex; gap: 1rem; margin-top: 1.2rem;">
        <form method="POST" action="/add-checklist-and-voyage/{{ destination.id }}">
          <button class="add-trip-btn" type="submit">Ajouter ce voyage</button>
        </form>

        
      </div>
    </div>
  </div>
</div>
<div class="write-journal-container">
  <a href="/destination/{{ destination.id }}/carnet/new" class="add-trip-btn">‚úçÔ∏è √âcrire un carnet</a>
</div>

<div class="destination-sections">
  {% for section in destination.sections %}
    <section class="section section-{{ section.type | lower }}">
      <h2>{{ section.titre }}</h2>
      <p>{{ section.contenu }}</p>

      {% if section.images.length > 0 %}
        <div class="section-images">
          {% for image in section.images %}
            {% set imgPath = image.url starts with '/uploads/' ? image.url : '/uploads/' ~ image.url %}
            <img src="{{ imgPath }}" alt="Image de la section {{ section.titre }}">
          {% endfor %}
        </div>
      {% endif %}

      {% if section.bulletPoints.length > 0 %}
        <ul class="bullet-list">
          {% for bullet in section.bulletPoints %}
            <li>{{ bullet.contenu }}</li>
          {% endfor %}
        </ul>
      {% endif %}

      {% if section.groupedPoints.length > 0 %}
        <div class="grouped-bullets">
          {% for group in section.groupedPoints %}
            <h4>{{ group.titre }}</h4>
            <ul>
              {% for point in group.contents %}
                <li>{{ point.contenu }}</li>
              {% endfor %}
            </ul>
          {% endfor %}
        </div>
      {% endif %}
    </section>
  {% endfor %}
</div>

<hr style="margin-top: 3rem; margin-bottom: 2rem;">

<!-- ‚úÖ Bloc AVIS -->
<section class="last-reviews">
  <div class="testimonial-header">
    <div class="testimonial-banner-container">
      <img src="/assets/image/11190.jpg" alt="Fond lac gel√©" class="testimonial-banner">
      <h2 class="testimonial-title">Avis voyageurs</h2>
    </div>
  </div>

  <div class="testimonial-actions">
    <a href="/destination/{{ destination.id }}/reviews" class="add-review-btn">Ajouter un commentaire</a>
  </div>

  {% if lastTwoReviews is empty %}
    <p style="text-align:center; margin-top:2em;">Aucun avis pour cette destination.</p>
  {% else %}
    <div class="testimonial-list">
      {% for review in lastTwoReviews %}
        {% set avatarPath = review.user.avatar starts with '/uploads/' 
            ? review.user.avatar 
            : '/uploads/' ~ (review.user.avatar ?: 'default-avatar.png') %}
        <div class="testimonial-card">
          <img class="avatar" src="{{ avatarPath }}" alt="{{ review.user.prenom }} {{ review.user.nom }}" />
          <div class="testimonial-content">
            <span class="testimonial-name">
              {{ review.user.prenom }}
              <span class="stars">
                {% for i in 1..review.rating %}‚òÖ{% endfor %}
                {% for i in review.rating+1..5 %}<span style="opacity:.2;">‚òÖ</span>{% endfor %}
              </span>
            </span>
            <div class="testimonial-text">
              {{ review.content }}
            </div>
            <div style="margin-top:8px;">
              <span style="font-size:15px; color:#bbb;">üëç {{ review.likes|length }} like{{ review.likes|length > 1 ? 's' : '' }}</span>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    <div class="testimonial-actions">
      <a href="/destination/{{ destination.id }}/reviews" style="font-weight: bold;">Voir tous les avis &rarr;</a>
    </div>
  {% endif %}
</section>

<!-- ‚úÖ Bloc CARNETS DE VOYAGE -->
<section class="travel-journals">
  <div class="testimonial-header">
    <div class="testimonial-banner-container">
      <img src="/assets/image/11191.jpg" alt="Carnets de voyage" class="testimonial-banner">
      <h2 class="testimonial-title">Carnets de voyage</h2>
    </div>
  </div>

  {% if travelJournals is empty %}
    <p style="text-align:center; margin-top:2em;">Aucun carnet de voyage n‚Äôa encore √©t√© partag√© pour cette destination.</p>
  {% else %}
    <div class="testimonial-list">
      {% for journal in travelJournals %}
        {% if journal.photos is defined and journal.photos|length > 0 %}
          {% set firstPhoto = journal.photos[0] %}
          {% set photoPath = firstPhoto.url starts with '/uploads/' 
            ? firstPhoto.url 
            : '/uploads/' ~ firstPhoto.url %}
        {% else %}
          {% set photoPath = '/uploads/default.jpg' %}
        {% endif %}

        <div class="testimonial-card">
          <img class="avatar" src="{{ photoPath }}" alt="Photo carnet" />
          <div class="testimonial-content">
            <span class="testimonial-name">
              {{ journal.user.prenom }} {{ journal.user.nom }}
              <span class="stars">
                {% for i in 1..(journal.note ?: 0) %}‚òÖ{% endfor %}
                {% for i in (journal.note ?: 0)+1..5 %}<span style="opacity:.2;">‚òÖ</span>{% endfor %}
              </span>
            </span>
            <div class="testimonial-text">
              {{ journal.contenu|slice(0, 160) ~ '‚Ä¶' }}
            </div>
            <div style="margin-top:8px;">
              <span style="font-size:14px; color:#888;">
                üìÖ du {{ journal.dateDebut|date("d/m/Y") }} au {{ journal.dateFin|date("d/m/Y") }}
              </span>
              <br>
              <a href="/carnet/{{ journal.id }}" style="font-weight: bold;">Lire le carnet ‚Üí</a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- ‚úÖ Affiche le bouton ici, en dehors de la boucle -->
    <div class="testimonial-actions">
      <a href="/destination/{{ destination.id }}/carnets" class="add-review-btn">Voir tous les carnets</a>
    </div>
  {% endif %}
</section>


{% endblock %}
